#!/bin/bash

BUILDER=$( locate "MSBuild.exe" | grep "/cygdrive/c/Program Files (x86)/.\+MSBuild.exe$" | head -n1 )

echo "Mapping drive"
net use \\\\CI\\ci /user:ci "LxVV5JpIGAmlKTgJOTpX56D53WO391lT"

cd //CI/ci/sources/libtranslate
if [[ $? -ne 0 ]]; then
echo Cannot cd into build
exit 1
fi

cd codegen/native/
git submodule init
git submodule update
if [[ $? -ne 0 ]]; then
    echo "Failed to checkout native submodule"
    exit 1
fi
cd ../../

STATUS=0

echo "{CI_SECTION_START} MSBuild"
"$BUILDER" libtranslate.vcxproj /p:Configuration="Release"
if [[ $? -ne 0 ]]; then
    STATUS=1
fi
echo "{CI_SECTION_END}"

echo "{CI_SECTION_START} Test"
echo "No tests yet."
echo "{CI_SECTION_END}"

if [[ $STATUS -ne 0 ]]; then
    exit 1
fi
